# 操作系统的引导

## 实验目的

- 建立对操作系统引导过程的深入认识；
- 掌握操作系统的基本开发过程；

## 实验内容

此次实验的基本内容是：编写一个放入引导扇区的操作系统引导程序 `bootsect.s`，和一个进入保护模式前的设置程序 `setup.s`，并将该 `bootsect.s` 和 `setup.s` 编译后在 Bochs 中运行，进行实验。

编写的引导程序 `bootsect.s` 和 `setup.s` 主要完成如下三个部分的功能：

- `bootsect.s` 能在屏幕上打印一段提示信息 “XXX is booting...”，其中 XXX 是你给自己的操作系统起的名字，例如 LZJos、Sunix 等。
- `bootsect.s` 能完成 `setup.s` 的载入，并跳转到 `setup.s` 开始地址执行。而 `setup.s` 还应向屏幕输出一行提示信息。
- `setup.s` 能获取基本的硬件参数（如内存参数、显卡参数、硬盘参数等），将这些参数放在内存的特定地址，留着将来使用，并输出到屏幕上。

## 提示

`bootsect.s` 可在原本内容上修改，`setup.s` 应删去原先内容并复制一份 `bootsect.s` 进行编写。

### 获取参数

`setup.s` 将获得硬件参数放在内存的 `0x90000` 处。原版 `setup.s` 中已经完成了光标位置、内存大小、显存大小、显卡参数、第一和第二硬盘参数的保存。

用 `ah=#0x03` 调用 `0x10` 中断可以读出光标的位置，用 `ah=#0x88` 调用 `0x15` 中断可以读出内存的大小。有些硬件参数的获取要稍微复杂一些，如磁盘参数表。在 PC 机中 BIOS 设定的中断向量表中 `int 0x41` 的中断向量位置 (`4*0x41 = 0x0000:0x0104`) 存放的并不是中断程序的地址，而是第一个硬盘的基本参数表。第二个硬盘的基本参数表入口地址存于 `int 0x46` 中断向量位置处。每个硬盘参数表有 16 个字节大小。下表给出了硬盘基本参数表的内容：
________

|位移|大小|说明|
|:-:|:-:|:-:|
|0x00|字|柱面数|
|0x02|字节|磁头数|
|…|…|…|
|0x0E|字节|每磁道扇区数|
|0x0F|字节|保留|

所以获得磁盘参数的方法就是复制数据。

下面是将硬件参数取出来放在内存 `0x90000` 的关键代码。

```asm
mov ax,#INITSEG 
mov ds,ax !设置ds=0x9000
mov ah,#0x03 !读入光标位置
xor bh,bh
int 0x10  !调用0x10中断
mov [0],dx  !将光标位置写入0x90000.

!读入内存大小位置
mov ah,#0x88
int 0x15
mov [2],ax

!从0x41处拷贝16个字节（磁盘参数表）
mov ax,#0x0000
mov ds,ax
lds si,[4*0x41]
mov ax,#INITSEG
mov es,ax
mov di,#0x0004
mov cx,#0x10
rep   !重复16次
movsb
```

现在已经将硬件参数（只包括光标位置、内存大小和硬盘参数，其他硬件参数取出的方法基本相同，此处略去）取出来放在了0x90000处，接下来的工作是将这些参数显示在屏幕上。这些参数都是一些无符号整数，所以需要做的主要工作是用汇编程序在屏幕上将这些整数显示出来。

Hex 显示见代码实现。
